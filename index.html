<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mobile Responsive Student Report</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-color: #4a90e2;
            --secondary-color: #f0f4f7;
            --text-dark: #333;
            --success-color: #28a745;
            --border-radius: 12px;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background: #eef2f7;
            color: var(--text-dark);
            margin: 0;
            padding: 20px;
        }

        /* Main Card */
        .main-container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: var(--border-radius);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            text-align: center;
        }

        .header-section {
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 15px;
            margin-bottom: 25px;
        }

        h2.app-title {
            margin: 0;
            color: var(--primary-color);
            font-size: 24px;
        }

        .info-text {
            color: #666;
            font-size: 14px;
            margin-top: 5px;
        }

        /* Controls */
        .controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
            align-items: center;
        }

        input[type="file"] {
            padding: 10px;
            background: #f8f9fa;
            border: 1px dashed #ccc;
            border-radius: 8px;
            width: 100%;
            box-sizing: border-box;
            /* Ensures padding doesn't break width */
        }

        .btn {
            background: var(--success-color);
            color: white;
            padding: 14px 30px;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            border-radius: 50px;
            transition: transform 0.2s;
            width: auto;
            min-width: 200px;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        #status {
            margin-top: 15px;
            font-weight: bold;
            color: var(--primary-color);
            font-size: 14px;
        }

        /* --- PDF PREVIEW STYLING --- */
        #pdf-content {
            background: white;
            /* Mobile par width 100% rahegi, Desktop par max 1000px */
            width: 100%;
            max-width: 1000px;
            margin: 30px auto 0;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            box-sizing: border-box;
            /* Prevents overflow */
        }

        .student-page {
            padding: 20px;
            page-break-after: always;
            border-bottom: 1px dashed #ccc;
            text-align: left;
        }

        @media print {
            .student-page {
                border-bottom: none;
            }
        }

        h2.student-name {
            margin: 0 0 15px 0;
            color: #2c3e50;
            border-bottom: 2px solid #5aa9e6;
            display: inline-block;
            padding-bottom: 5px;
            font-size: 18px;
        }

        /* --- RESPONSIVE TABLE --- */
        /* Wrapper to allow scrolling on mobile */
        .table-responsive {
            width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            /* Smooth scroll on iPhone */
            margin-top: 15px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 600px;
            /* Forces scroll on small screens if needed */
        }

        th,
        td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
            font-size: 13px;
        }

        th {
            background-color: #f8f9fa;
            font-weight: bold;
            color: #444;
        }

        .summary {
            margin-top: 15px;
            font-weight: bold;
            text-align: right;
            font-size: 14px;
        }

        /* --- MOBILE MEDIA QUERIES (The Magic Part) --- */
        @media (max-width: 600px) {
            body {
                padding: 10px;
                background: #fff;
            }

            /* Remove grey background on mobile */
            .main-container {
                padding: 20px 15px;
                box-shadow: none;
            }

            h2.app-title {
                font-size: 20px;
            }

            .btn {
                width: 100%;
                padding: 15px;
            }

            /* Full width button */

            .student-page {
                padding: 15px;
            }

            /* Less padding in preview */

            h2.student-name {
                font-size: 16px;
            }

            /* Table fonts smaller on mobile preview */
            th,
            td {
                padding: 8px;
                font-size: 12px;
            }
        }
    </style>
</head>

<body>

    <div class="main-container">
        <div class="header-section">
            <h2 class="app-title">Student Report Generator</h2>
            <p class="info-text">Upload Excel &rarr; Group by Name &rarr; Landscape PDF</p>
        </div>

        <div class="controls">
            <input type="file" id="upload" accept=".xlsx, .xls" />
            <button id="generateBtn" class="btn" disabled>Download PDF</button>
        </div>

        <div id="status">Waiting for file...</div>
    </div>

    <div id="pdf-content"></div>

    <script>
        let excelData = [];
        const uploadInput = document.getElementById('upload');
        const generateBtn = document.getElementById('generateBtn');
        const statusDiv = document.getElementById('status');
        const pdfContainer = document.getElementById('pdf-content');

        uploadInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            statusDiv.innerText = "Loading file...";

            const reader = new FileReader();
            reader.onload = (e) => {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const sheetName = workbook.SheetNames[0];
                const sheet = workbook.Sheets[sheetName];
                excelData = XLSX.utils.sheet_to_json(sheet);

                if (excelData.length > 0) {
                    statusDiv.innerText = `Loaded ${excelData.length} rows.`;
                    generateBtn.disabled = false;
                    renderHTML(excelData);
                } else {
                    statusDiv.innerText = "Error: File is empty.";
                }
            };
            reader.readAsArrayBuffer(file);
        });

        // Grouping Logic
        function groupBy(data) {
            return data.reduce((storage, item) => {
                const key = Object.keys(item).find(k => k.toLowerCase().includes('name')) || Object.keys(item)[0];
                const groupValue = item[key];
                (storage[groupValue] = storage[groupValue] || []).push(item);
                return storage;
            }, {});
        }

        function renderHTML(data) {
            pdfContainer.innerHTML = '';
            const groupedData = groupBy(data);

            Object.keys(groupedData).forEach(studentName => {
                const records = groupedData[studentName];

                const pageDiv = document.createElement('div');
                pageDiv.className = 'student-page';

                pageDiv.innerHTML = `<h2 class="student-name">Student: ${studentName}</h2>`;

                // Added Wrapper div for Responsive Scrolling
                let tableHtml = `<div class="table-responsive"><table><thead><tr>`;

                const headers = Object.keys(records[0]);
                headers.forEach(h => tableHtml += `<th>${h}</th>`);
                tableHtml += `</tr></thead><tbody>`;

                records.forEach(row => {
                    tableHtml += `<tr>`;
                    headers.forEach(h => tableHtml += `<td>${row[h] || '-'}</td>`);
                    tableHtml += `</tr>`;
                });
                tableHtml += `</tbody></table></div>`; // Close wrapper

                tableHtml += `<div class="summary">Total Records: ${records.length}</div>`;

                pageDiv.innerHTML += tableHtml;
                pdfContainer.appendChild(pageDiv);
            });
        }

        generateBtn.addEventListener('click', async () => {
            const pages = document.querySelectorAll('.student-page');
            if (pages.length === 0) {
                alert('No data to generate PDFs from.');
                return;
            }

            // Logic Changed: Loop through pages, generate individual blobs, zip them
            const opt = {
                margin: 0.4,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true },
                jsPDF: { unit: 'in', format: 'letter', orientation: 'landscape' }
            };

            statusDiv.innerText = "Initializing ZIP generation...";
            generateBtn.disabled = true;

            try {
                const zip = new JSZip();

                for (let i = 0; i < pages.length; i++) {
                    const page = pages[i];
                    // Find student name for filename
                    const nameHeader = page.querySelector('h2.student-name');
                    let rawName = nameHeader ? nameHeader.innerText : `Student_${i + 1}`;
                    // "Student: Hassan" -> "Hassan"
                    if (rawName.startsWith("Student: ")) {
                        rawName = rawName.substring(9);
                    }
                    const safeName = rawName.replace(/[^a-zA-Z0-9\-_]/g, '_');

                    statusDiv.innerText = `Generating PDF: ${rawName} (${i + 1}/${pages.length})...`;

                    // Generate Blob for this specific page element
                    const pdfBlob = await html2pdf().set(opt).from(page).output('blob');
                    zip.file(`${safeName}.pdf`, pdfBlob);
                }

                statusDiv.innerText = "Zipping files...";
                const zipContent = await zip.generateAsync({ type: "blob" });
                saveAs(zipContent, "Student_Reports.zip");

                statusDiv.innerText = "Done! ZIP Downloaded.";
            } catch (err) {
                console.error(err);
                statusDiv.innerText = "Error generating files: " + err.message;
            } finally {
                generateBtn.disabled = false;
            }
        });
    </script>
</body>

</html>